<html>

    <head>

         <script src="easeljs-0.8.0.min.js"></script>
         <script src="preloadjs-0.6.0.min.js"></script>
    </head>

    <body onload="init();">

        <canvas id="shroomvas" width="900" height="500"></canvas> 

        <script>
            var stage, w, h, loader, rotation;
            var background, hipster;
            var shrooms, shroom, actionShroom, actionBoard;
            var points, lives, pointsLabel, livesLabel, speed;

            function init() {
                lives = 3;
                points = 0;

                loader = new createjs.LoadQueue(false);
                stage = new createjs.Stage("shroomvas");
                w = stage.canvas.width;
                h = stage.canvas.height;

                manifest = [
                    {src: "background.png", id: "background"},
                    {src: "spritesheet-hipster.png", id: "hipster"},
                    {src: "chantarelle.png", id: "chantarelle"},
                    {src: "deathcap.png", id: "deathcap"},
                    {src: "trashcan.png", id: "trashcan"},
                    {src: "cauldron.png", id: "cauldron"},
                    
                ];

                loader.addEventListener("complete", handleComplete); 
                loader.loadManifest(manifest, true, "resources/");
            }

            function handleComplete() {

                rotation = 0;

                // Set up the background
                var backgroundImg = loader.getResult("background");
                background = new createjs.Shape();
                background.graphics.beginBitmapFill(backgroundImg).drawRect(0, 0, w+backgroundImg.width, h+backgroundImg.height);
                background.tileW = backgroundImg.width;
                background.y = h - backgroundImg.height;

                pointsLabel = new createjs.Text(points, "20px Arial", "#ff7700");
                pointsLabel.x = 20;
                pointsLabel.y = 20;

                livesLabel = new createjs.Text(lives, "20px Arial", "#ff7700");
                livesLabel.x = 20;
                livesLabel.y = 45;

                speed = 150;

                // Set up the hipster
                var hipsterImg = loader.getResult("hipster");
                var hipsterSpriteSheet = new createjs.SpriteSheet({
                    framerate: 10,
                    images: [hipsterImg],
                    frames: {width: 98, height: 120, regX: -50, regY: -280},
                    animations: {
                        run: [0, 9]
                    }
                });
                hipster = new createjs.Sprite(hipsterSpriteSheet, "run");

                // Set up shrooms
                shrooms = [
                    {
                        bitmap: new createjs.Bitmap(loader.getResult("chantarelle")),
                        y: 347,
                        edible: true
                    },
                    {
                        bitmap: new createjs.Bitmap(loader.getResult("deathcap")),
                        y: 353,
                        edible: false
                    }
                ];

                // Set up action board
                var actionBoardBg = new createjs.Shape();
                actionBoardBg.graphics.beginFill("#eee")
                    .setStrokeStyle(1)
                    .beginStroke("#000000")
                    .drawRoundRect(280, 20, 200, 100, 10);

                var trashcan = new createjs.Bitmap(loader.getResult("trashcan"));
                trashcan.x = 410;
                trashcan.y = 20;
                trashcan.on("click", trashcanHandler);

                var cauldron = new createjs.Bitmap(loader.getResult("cauldron"));
                cauldron.x = 410;
                cauldron.y = 50;
                cauldron.on("click", cauldronHandler);

                actionBoard = new createjs.Container();
                actionBoard.name = "actionBoard";
                actionBoard.addChild(actionBoardBg, trashcan, cauldron);

                // Set up basic game
                stage.addChild(background, hipster, pointsLabel, livesLabel);

                createjs.Ticker.timingMode = createjs.Ticker.RAF;
                createjs.Ticker.addEventListener("tick", tick);
                //tick(tick)
                //tick(tick)
            }

            function tick(event) {
                var deltaS = event.delta / 1000;

                if (shroom != undefined) {
                    if (shroom.bitmap.x < 55) {
                        actionShroom = shroom;
                        showActionBoard(actionShroom);
                        stage.removeChild(shroom.bitmap);
                        shroom = undefined;
                    } else {
                        shroom.bitmap.x = (shroom.bitmap.x - deltaS * speed);
                    }

                    if (stage.getChildByName("actionBoard") && shroom && shroom.bitmap.x < 300) {
                        hideActionBoard();
                    }
                }

                if (rotation % 200 == 0) {
                    randShroom = Math.floor(Math.random() * shrooms.length);
                    shroom = shrooms[randShroom];
                    addShroom(shroom);
                }

                if (rotation % 1000 == 0) {
                    speed += 10;
                }

                if (lives == 0) {
                    event.paused = true;
                }

                rotation = rotation + 1;
                if (!event.paused) {
                    stage.update(event);
                } else {
                }
            }

            function showActionBoard (actionShroom) {
                actionBitmap = actionShroom.bitmap.clone();
                actionBitmap.name = "actionShroom";
                actionBitmap.x = 300;
                actionBitmap.y = 40;
                actionBoard.addChild(actionBitmap);

                stage.addChild(actionBoard);
            }

            function hideActionBoard () {
                var actionShroom = actionBoard.getChildByName("actionShroom");
                actionBoard.removeChild(actionShroom, actionBoard);
                stage.removeChild(actionBoard);

            }
            
            function addShroom (shroom) {
                shroom.bitmap.x = 550;
                shroom.bitmap.y = shroom.y;
                stage.addChild(shroom.bitmap);
            }

            function cauldronHandler(evt, data) {
                hideActionBoard();
                if (actionShroom.edible) {
                    points = points + 10;
                } else {
                    lives = lives - 1;
                }

                pointsLabel.text = points;
                livesLabel.text = lives;
            }

            function trashcanHandler(evt, data) {
                hideActionBoard();
                if (actionShroom.edible) {
                    points = points - 5;
                } else {
                    points = points + 5;
                }

                pointsLabel.text = points;
            }
        </script>
    </body>
</html>
